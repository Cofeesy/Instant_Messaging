{{define "/chat/foot.shtml"}}
<script>

    function upload(dom) {
    // 使用 .then() 来接收回调
        util.uploadfile("attach/upload", dom).then(function (res) {
            if (res.code == 0) {
                console.log(res.data)
                app.sendpicmsg(res.data)
            }
        })
    }

    //上传图片 创建群
    function uploadthis(dom) {
        util.uploadfile("attach/upload", dom).then(function (res) {
            if (res.code == 0) {
                app.com.icon = res.data;
                console.log(res.data);
            }
        })
    }

    //维护用户头像
    function uploadUserInfo(dom) {
        util.uploadfile("attach/upload", dom).then(function (res) {
                app.info.icon = res.data;
                console.log(res.data);
        })
    }
    




    function userid() {
        var id = sessionStorage.getItem("userid");
        return id ? parseInt(id, 10) : 0;
    }
    // AI 伪用户 ID（后端约定）
    var AI_USER_ID = 0;
    var app = new Vue(
        {
            el: "#pageapp",
            data: {
                usermap: {},
                friends: [],
                groups: [],
                // 全局群组未读总数
                unreadGroupCount: 0,
                profile: {
                    avatar: "",
                    nickname: "",
                    memo: "",
                },
                webSocket: {},
                win: "main",
                com: {
                    "ownerId": "",
                    "icon": "",
                    "cate": "",
                    "username": "",
                    "memo": "",
                },
                info: {
                    id: "",
                    icon: "",
                    username: "",
                    phone: "",
                    email: "",
                },
                isDisable: true,
                isLoadMore: false,
                start: 0,
                end: 9,
                txtmsg: "",
                panelstat: "kbord",
                txtstat: "kbord",
                title: "",
                otherAvatar: '',
                doutu: {
                    config: {
                        "baseurl": "asset/plugins/doutu",
                        "pkgids": ["mkgif", "emoj"]
                    },
                    packages: [],
                    choosed: { "pkgid": "emoj", "assets": [], "size": "small" }
                },
                msglist: [],
                isReadRedisMsg: [],  //是否已读取某个群组的缓存消息
                msgcontext: {
                    targetid: -1,
                    type: -1,
                    createTime: new Date().getTime(),
                    userid: userid()
                },
                plugins: [
                    {
                        icon: "icon-tupian",
                        name: "照片",
                        id: "upload",
                        slot: "<input accept=\"image/gif,image/jpeg,,image/png\" type=\"file\" onchange=\"upload(this)\" class='upload' />"
                    },

                    {
                        icon: "icon-paizhao",
                        name: "拍照",
                        id: "camera",
                        slot: "<input accept=\"image/*\" capture=\"camera\" type=\"file\" onchange=\"upload(this)\" class='upload' />"
                    },
                    {
                        icon: "icon-yuyin",
                        name: "语音",
                        id: "audiocall"
                    },
                    {
                        icon: "icon-shipin",
                        name: "视频",
                        id: "videocall"
                    },
                    {
                        icon: "icon-hongbao",
                        name: "红包",
                        id: "redpackage"
                    },
                    {
                        icon: "icon-zhuanzhang",
                        name: "转账",
                        id: "exchange"
                    },
                    {
                        icon: "icon-daohangdizhi",
                        name: "地址",
                        id: "address"
                    },
                    {
                        icon: "icon-zhanghu",
                        name: "名片",
                        id: "person"
                    }

                ],
                timer: 0,
                recorder: {},
                allChunks: [],
                iscomplete: false,
                duration: 0,
                showprocess: false,

            },
            created: function () {
                this.findfriends();
                this.loadgroups();
                this.loaddoutures();
                setInterval(this.heartbeat, 10 * 1000);
                var user = userInfo()
                //初始化websocket
                this.initwebsocket()
                this.initUser();

            },
            mounted: function () {

            },
            methods: {
                initUser() {
                    let userInfo = JSON.parse(sessionStorage.getItem('userinfo') || '{}');
                    this.info.icon = userInfo.icon;
                    this.info.username = userInfo.username;
                    this.info.id = userInfo.ID;
                    this.info.icon = userInfo.icon;
                    this.info.phone = userInfo.phone;
                    this.info.email = userInfo.email;
                    this.profile.nickname = userInfo.username;
                },
                playaudio: function (url) {
                    var audioEl = document.getElementById('audio4play');
                    if (!url) {
                        console.warn('[playaudio] empty or undefined url:', url);
                        try { audioEl.pause(); audioEl.removeAttribute('src'); } catch (e) {}
                        return;
                    }
                    // 如果传入的是相对路径并且不以 '/' 开头，保持原样；否则直接使用
                    try {
                        audioEl.pause();
                        audioEl.src = url;
                        // 强制重新加载资源，避免旧的加载阻塞新的播放请求
                        audioEl.load();
                        var playPromise = audioEl.play();
                        if (playPromise && typeof playPromise.then === 'function') {
                            playPromise.catch(function (err) {
                                console.error('[playaudio] play() failed:', err);
                            });
                        }
                    } catch (e) {
                        console.error('[playaudio] error while trying to play audio:', e);
                    }
                },
                startrecorder: function () {
                    let audioTarget = document.getElementById('audio');
                    var types = ["video/webm",
                        "audio/webm",
                        "video/webm\;codecs=vp8",
                        "video/webm\;codecs=daala",
                        "video/webm\;codecs=h264",
                        "audio/webm\;codecs=opus",
                        "video/mpeg"];
                    var suporttype = "";
                    for (var i in types) {
                        if (MediaRecorder.isTypeSupported(types[i])) {
                            suporttype = types[i];
                        }
                    }
                    if (!suporttype) {
                        mui.toast("编码不支持")
                        return;
                    }

                    this.duration = new Date().getTime();
                    //video 摄像头   ，audio 音频
                    navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                        .then(function (stream) {
                            this.showprocess = true
                            this.recorder = new MediaRecorder(stream);
                            audioTarget.srcObject = stream;
                            //是否可用
                            this.recorder.ondataavailable = (event) => {
                                console.log("ondataavailable");
                                uploadblob("attach/upload", event.data, ".mp3", res => {
                                    var duration = Math.ceil((new Date().getTime() - this.duration) / 1000);
                                    this.sendaudiomsg(res.Data, duration);
                                })
                                stream.getTracks().forEach(function (track) {
                                    track.stop();
                                });
                                this.showprocess = false
                            }
                            this.recorder.start();
                        }.bind(this)).
                        catch(function (err) {
                            console.log(err)
                            mui.toast(err)
                            this.showprocess = false
                        }.bind(this));
                },
                stoprecorder: function () {
                    if (typeof this.recorder.stop == "function") {
                        this.recorder.stop();
                    }
                    this.showprocess = false
                    console.log("stoprecorder")

                },
                dispatchplugin: function (item) {
                    switch (item.id) {
                        case "upload":
                        case "camera":

                            break;
                        default:
                            mui.toast("系统暂不支持,请自行扩展")
                    }
                },
                reset: function () {
                    this.panelstat = "kbord";
                    this.txtstat = "kbord";
                    this.txtmsg = "";
                },
                createmsgcontext: function () {
                    return JSON.parse(JSON.stringify(this.msgcontext))
                },
                loaddoutures: function () {
                    var res = [];
                    var config = this.doutu.config;
                    for (var i in config.pkgids) {
                        res[config.pkgids[i]] = (config.baseurl + "/" + config.pkgids[i] + "/info.json")
                    }
                    var that = this;
                    for (var id in res) {
                        this.$http.get(res[id]).then(response => {
                            pkginfo = response.data
                            var baseurl = config.baseurl + "/" + pkginfo.id + "/"
                            // console.log("post res[i]",id,res[id],pkginfo)
                            for (var j in pkginfo.assets) {
                                pkginfo.assets[j] = baseurl + pkginfo.assets[j];
                }
                    pkginfo.icon = baseurl + pkginfo.icon;
                            that.doutu.packages.push(pkginfo)
                            if (that.doutu.choosed.pkgid == pkginfo.id) {
                                // 使用 $set 保证响应式更新，避免直接替换数组导致模板不更新
                                try {
                                    that.$set(that.doutu.choosed, 'assets', pkginfo.assets);
                                } catch (e) {
                                    // 兼容没有 $set 的情形（极少见）
                                    that.doutu.choosed.assets = pkginfo.assets;
                                }
                            }

                        })
                    }
                    // 事件代理移除：已切回使用 Vue 的 @click/@tap 处理表情点击，移除全局代理以减少副作用
                },
                showweixin: function () {
                    mui.alert("请加微信号msb-shenzhuan索取")
                },
                showmsg: function (user, msg, isReverse, isFirst) {
                    // console.log("【showmsg】开始显示消息，user=", user, "msg=", msg);
                    // console.log("【showmsg】当前win状态=", this.win, "msgcontext.targetid=", this.msgcontext.targetid);
                    
                    var data = {};
    
                    // 【关键修改】如果消息 ID 是 0，绝对显示在左边
                    if (msg.userid === 0) {
                        data.ismine = false;
                    } else {
                        data.ismine = userid() == (msg.userid);
                    }
                    
                    data.user = user;
                    data.msg = msg;
                    // console.log("【showmsg】消息信息：ismine=", data.ismine, "msglist长度=", this.msglist.length);
                    
                    if (isReverse) {
                        this.msglist = [data].concat(this.msglist);
                    } else {
                        //首次获取消息渲染
                        if (isFirst) {
                            this.msglist = [data].concat(this.msglist);
                            //下拉获取消息渲染
                        } else {
                            this.msglist = this.msglist.concat(data)
                        }
                    }
                    
                    // console.log("【showmsg】消息已添加到msglist，新长度=", this.msglist.length);
                    this.reset();
                    var that = this;
                    that.timer = setTimeout(function () {
                        // console.log("【showmsg】延时回调执行，准备滚动");
                        window.scrollTo(0, document.getElementById("convo").offsetHeight);
                        if (!isReverse) {
                            let scroll = document.querySelector("#convo .mui-scroll-wrapper").offsetHeight;
                            let inner = document.querySelector("#convo .mui-scroll").offsetHeight;
                            let y = scroll - inner - 80;
                            let transform = document.querySelector("#convo .mui-scroll").style.transform;
                            document.querySelector("#convo .mui-scroll").style.transform = 'translateY(' + y + 'px)';
                            // console.log("【showmsg】滚动到底部，y=", y);
                        } else {
                            document.querySelector("#convo .mui-scroll").style.transform = 'translateY(' + 0 + 'px)';
                        }

                        clearTimeout(that.timer)
                    }, 100) // 延时 100ms 等待 Vue 渲染完成
                },
                startrecord: function () {

                },
                //跟谁单聊
                sendtxtmsg: function (txt) {
                    if (this.isDisable) {
                        this.setTimeFlag()
                        //{id:1,userid:2,dstid:3,cmd:10,media:1,content:"hello"}
                        var msg = this.createmsgcontext();
                        msg.media = 1;
                        msg.content = txt;
                        // 【修复】所有消息都立即显示（私聊和群聊）
                        this.showmsg(userInfo(), msg);

                        this.webSocket.send(JSON.stringify(msg))
                    }
                },
                sendpicmsg: function (picurl) {
                    if (this.isDisable) {
                        this.setTimeFlag()
                        //{id:1,userid:2,dstid:3,cmd:10,media:4,url:"http://www.baidu.com/a/log,jpg"}
                        var msg = this.createmsgcontext();
                        // 如果是表情包资源（来自 doutu），也按图片发送（media=4）
                        msg.media = 4;
                        msg.url = picurl;
                        // 临时日志，便于定位表情包发送问题
                        console.log("[sendpicmsg] 发送图片/表情包消息 payload:", msg);
                        // 【修复】所有消息都立即显示（私聊和群聊）
                        this.showmsg(userInfo(), msg);
                        // 发送前再次序列化并打印（帮助后端定位）
                        try {
                            var payload = JSON.stringify(msg);
                            console.log("[sendpicmsg] websocket send string:", payload);
                            this.webSocket.send(payload);
                        } catch (e) {
                            console.error('[sendpicmsg] 序列化或发送失败', e);
                        }
                    }
                },
                sendaudiomsg: function (url, num) {
                    if (!url) {
                        console.warn('[sendaudiomsg] empty url, abort sending audio message:', url);
                        return;
                    }

                    if (this.isDisable) {
                        this.setTimeFlag()
                        //{id:1,userid:2,dstid:3,cmd:10,media:3,url:"http://www.a,com/dsturl.mp3",anount:40}
                        var msg = this.createmsgcontext();
                        msg.media = 3;
                        msg.url = url;
                        msg.amount = num;
                        // 【修复】所有消息都立即显示（私聊和群聊）
                        this.showmsg(userInfo(), msg);
                        //console.log("sendaudiomsg",this.msglist);
                        this.webSocket.send(JSON.stringify(msg))
                    }
                },
                scrollConcat() {
                    console.log(123)
                },
                closePanel() {
                    this.panelstat = 'kbord';
                },
            //     singlemsg: function (user) {
            //     var that = this;
            //     this.start = 0;
            //     this.end = 9;
            //     this.isLoadMore = false;

            //     if (this.isDisable) {
            //         this.msglist = []; // 清空当前消息列表
                    
            //         // 设置当前聊天上下文
            //         this.win = "single";
            //         this.title = "和 " + user.username + " 聊天中";
            //         this.otherAvatar = user.Avatar;
            //         this.msgcontext.targetid = parseInt(user.ID);
            //         this.msgcontext.type = 1;

            //         // 定义通用的渲染逻辑
            //         var processAndShow = function(rows, isReverse) {
            //             rows.forEach(function(item) {
            //                 // 如果是字符串先解析
            //                 if (typeof item === 'string') { try { item = JSON.parse(item); } catch (e) {} }
            //                 that.showmsg(user, item, isReverse, false);
            //             });
            //         };

            //         // 首次加载
            //         util.post("user/getSingleMessagesFromRedis", { 
            //             userid: userid(), 
            //             targetid: user.ID, 
            //             start: this.start, 
            //             end: this.end, 
            //             isreverse: false 
            //         }).then(function (res) {
            //             if (res.code === 0 && res.data && res.data.Rows) {
            //                 processAndShow(res.data.Rows, false);
            //             } else {
            //                 console.log("【singlemsg】无历史消息或数据格式为空");
            //             }
            //         }).catch(function(err){ 
            //             console.error('加载历史消息失败:', err);
            //         });

            //         this.setTimeFlag();

            //         // 初始化滚动与监听
            //         setTimeout(function() {
            //             mui('.mui-scroll-wrapper').scroll({
            //                 scrollY: true, scrollX: false, startX: 0, startY: 0,
            //                 indicators: true, deceleration: 0.0006, bounce: true
            //             });
                        
            //             // 监听上拉加载更多
            //             document.querySelector('.mui-scroll-wrapper').addEventListener('scroll', function (e) {
            //                 let translate = e.target.style?.transform?.match(/translate3d\(\d+px,\s*(\d+)px,\s*(\d+)px\)/i);
            //                 if (translate && translate.length > 1) {
            //                     if (translate[1] > 0 && that.isLoadMore == false) {
            //                         that.isLoadMore = true;
            //                         that.start = that.end + 1;
            //                         that.end = that.end + 10;
                                    
            //                         util.post("user/getSingleMessagesFromRedis", { 
            //                             userid: userid(), 
            //                             targetid: user.ID, 
            //                             start: that.start, 
            //                             end: that.end, 
            //                             isreverse: false 
            //                         }).then(function (res) {
            //                             if (res.code === 0 && res.data && res.data.Rows) {
            //                                 processAndShow(res.data.Rows, true); // true 代表插入到头部
            //                             }
            //                             setTimeout(function() { that.isLoadMore = false; }, 300);
            //                         });
            //                         that.isReadRedisMsg.push(user.ID);
            //                     }
            //                 }
            //             });
            //         }, 200);
            //     }
            // },
            singlemsg: function (user) {
            var that = this;

            this.cursor = 0;   // 0 获取最新消息
            this.limit = 20;   // 每次拉取 20 条
            this.isLoadMore = false;
            this.isFinished = false; // 标记是否没有更多数据了

            if (this.isDisable) {
                this.msglist = []; // 清空当前消息列表
                
                // 设置当前聊天上下文
                this.win = "single";
                this.title = "和 " + user.username + " 聊天中";
                this.otherAvatar = user.Avatar;
                this.msgcontext.targetid = parseInt(user.ID);
                this.msgcontext.type = 1;

                // 渲染逻辑中增加游标更新
               var processAndShow = function(rows, isReverse) {
                    if (!rows || rows.length === 0) {
                        that.isFinished = true;
                        return;
                    }

                    var lastMsg = rows[rows.length - 1];
                    if (typeof lastMsg === 'string') { try { lastMsg = JSON.parse(lastMsg); } catch (e) {} }
                    
                    if (lastMsg && lastMsg.createTime) {
                        that.cursor = lastMsg.createTime;
                    }

                    if (!isReverse) {
                        rows.reverse();
                    }
                    
                    rows.forEach(function(item) {
                        if (typeof item === 'string') { try { item = JSON.parse(item); } catch (e) {} }
                        that.showmsg(user, item, isReverse, false);
                    });
                };

                // 首次加载
                util.post("user/getSingleMessagesFromRedis", { 
                    userid: userid(), 
                    targetid: user.ID, 
                    cursor: 0,        // 传 0 拉最新的
                    limit: this.limit 
                }).then(function (res) {
                    var list = (res.data && res.data.Rows) ? res.data.Rows : res.data;

                    if (res.code === 0 && list && list.length > 0) {
                        processAndShow(list, false);
                    } else {
                        console.log("【singlemsg】无历史消息");
                        that.isFinished = true; // 没数据标记结束
                    }
                }).catch(function(err){ 
                    console.error('加载历史消息失败:', err);
                });

                this.setTimeFlag();

                // 初始化滚动与监听
                setTimeout(function() {
                    mui('.mui-scroll-wrapper').scroll({
                        scrollY: true, scrollX: false, startX: 0, startY: 0,
                        indicators: true, deceleration: 0.0006, bounce: true
                    });
                    
                    // 监听上拉加载更多
                    document.querySelector('.mui-scroll-wrapper').addEventListener('scroll', function (e) {
                        let translate = e.target.style?.transform?.match(/translate3d\(\d+px,\s*(\d+)px,\s*(\d+)px\)/i);
                        if (translate && translate.length > 1) {
                            // 判断条件增加 isFinished，防止到底了还请求
                            if (translate[1] > 0 && that.isLoadMore == false && that.isFinished == false) {
                                that.isLoadMore = true;
                                
                                // 直接使用 processAndShow 里更新过的 that.cursor

                                util.post("user/getSingleMessagesFromRedis", { 
                                    userid: userid(), 
                                    targetid: user.ID, 
                                    cursor: that.cursor, // 传上一页最后一条的时间
                                    limit: that.limit
                                }).then(function (res) {
                                    var list = (res.data && res.data.Rows) ? res.data.Rows : res.data;

                                    if (res.code === 0 && list && list.length > 0) {
                                        processAndShow(list, true); // true 代表插入到头部
                                    } else {
                                        that.isFinished = true; // 返回空，说明没有更多历史记录了
                                    }
                                    setTimeout(function() { that.isLoadMore = false; }, 300);
                                });
                                
                                that.isReadRedisMsg.push(user.ID);
                            }
                        }
                    });
                }, 200);
            }
        },
                // 进入 AI 聊天窗口
                // 进入 AI 聊天窗口
                aiChat: function () {
                var that = this;
                this.start = 0;
                this.end = 9;
                this.isLoadMore = false;

                if (this.isDisable) {
                    this.msglist = []; 
                    this.win = "single";
                    this.title = "AI 助手";
                    this.otherAvatar = '/asset/images/ai_bot.png';
                    this.msgcontext.targetid = AI_USER_ID; // 0
                    this.msgcontext.type = 1;              // 私聊类型

                    var processAndShowAI = function(rows, isReverse) {
                        rows.forEach(function (item, index) {
                            // 1. 数据清洗
                            if (typeof item === 'string') { try { item = JSON.parse(item); } catch (e) { } }
                            
                            // 2. 补全字段，通过 HTML v-if 检查
                            item.type = 1; // 强转为私聊
                            if (item.targetid === undefined) item.targetid = 0;
                            if (item.userid === undefined) item.userid = 0;
                            
                            // 3. 修复 ID 0 问题
                            if (!item.id || item.id == 0) item.id = new Date().getTime() + index + Math.random();

                            // 4. 显示逻辑
                            if (item.userid == 0) {
                                var aiUser = { username: 'AI 助手', icon: '/asset/images/ai_bot.png' };
                                item.userid = 0;
                                that.showmsg(aiUser, item, isReverse, false);
                            } else if (item.userid == userid()) {
                                var myUser = {
                                    username: that.info.username || '我',
                                    icon: that.info.icon || '/asset/images/avatar0.png'
                                };
                                that.showmsg(myUser, item, isReverse, false);
                            } else {
                                that.loaduserinfo(item.userid, function (userinfo) {
                                    that.showmsg(userinfo || {username:'用户'}, item, isReverse, false);
                                });
                            }
                        });
                    };

                    // 首次加载
                    util.post("message/getAiMessagesFromRedis", {
                        userid: userid(),
                        targetid: AI_USER_ID,
                        start: this.start,
                        end: this.end,
                        isreverse: false
                    }).then(function (res) {
                        if (res.code === 0 && res.data && res.data.Rows) {
                            processAndShowAI(res.data.Rows, false);
                        }
                    }).catch(function (err) { console.error(err); });

                    this.setTimeFlag();

                    // 滚动与加载更多
                    setTimeout(function () {
                        mui('.mui-scroll-wrapper').scroll({
                            scrollY: true, scrollX: false, startX: 0, startY: 0,
                            indicators: true, deceleration: 0.0006, bounce: true
                        });
                        var scrollDom = document.querySelector("#convo .mui-scroll-wrapper");
                        if(scrollDom) window.scrollTo(0, scrollDom.scrollHeight);

                        document.querySelector('.mui-scroll-wrapper').addEventListener('scroll', function (e) {
                            let translate = e.target.style?.transform?.match(/translate3d\(\d+px,\s*(\d+)px,\s*(\d+)px\)/i);
                            if (translate && translate.length > 1) {
                                if (translate[1] > 0 && that.isLoadMore == false) {
                                    that.isLoadMore = true;
                                    that.start = that.end + 1;
                                    that.end = that.end + 10;
                                    
                                    util.post("message/getAiMessagesFromRedis", {
                                        userid: userid(),
                                        targetid: AI_USER_ID,
                                        start: that.start,
                                        end: that.end,
                                        isreverse: false
                                    }).then(function (res) {
                                        if (res.code === 0 && res.data && res.data.Rows) {
                                            processAndShowAI(res.data.Rows, true);
                                        }
                                        setTimeout(function() { that.isLoadMore = false; }, 300);
                                    });
                                }
                            }
                        });
                    }, 200);
                }
            },
                groupmsg: function (group) {
                var that = this;
                this.start = 0;
                this.end = 9;
                this.isLoadMore = false;
                console.log("进入群聊:", group);

                // 清理未读计数
                try {
                    this.groups.forEach(function(g){
                        if(parseInt(g.ID) === parseInt(group.ID)) {
                            that.unreadGroupCount = Math.max(0, (that.unreadGroupCount || 0) - (g.unread || 0));
                            g.unread = 0;
                        }
                    });
                } catch (e) { console.error(e); }

                if (this.isDisable) {
                    this.msglist = []; 
                    this.win = "group";
                    this.title = group.groupname;
                    this.msgcontext.targetid = parseInt(group.ID);
                    this.msgcontext.type = 2; // 群聊类型
                    this.otherAvatar = group.icon || '/asset/images/avatar0.png';

                    // 核心渲染逻辑
                    var processAndShowGroup = function(rows, isReverse) {
                        rows.forEach(function (item, index) {
                            // 1. 数据清洗
                            if (typeof item === 'string') { try { item = JSON.parse(item); } catch (e) { } }
                            item.type = 2; // 强转为群聊类型
                            item.targetid = parseInt(group.ID); // 修复 targetid 丢失问题
                            
                            // 2. 修复 ID 问题
                            if (!item.id || item.id == 0) item.id = new Date().getTime() + index + Math.random();

                            // 3. 显示逻辑
                            if (item.userid == userid()) {
                                var myUser = {
                                    username: that.info.username || '我',
                                    icon: that.info.icon || '/asset/images/avatar0.png'
                                };
                                that.showmsg(myUser, item, isReverse, false);
                            } else {
                                // 查询群友信息
                                that.loaduserinfo(item.userid, function (userinfo) {
                                    if (!userinfo) userinfo = { username: '群友'+item.userid, icon: '/asset/images/avatar0.png' };
                                    that.showmsg(userinfo, item, isReverse, false);
                                });
                            }
                        });
                    };

                    // 首次加载
                    util.post("message/getGroupMessagesFromRedis", { 
                        groupId: group.ID, 
                        start: this.start, 
                        end: this.end 
                    }).then(function (res) {
                        if (res.code === 0 && res.data && res.data.Rows) {
                            processAndShowGroup(res.data.Rows, false);
                        }
                    }).catch(function (err) { console.error(err); });

                    this.setTimeFlag();

                    // 滚动与加载更多
                    setTimeout(function () {
                        mui('.mui-scroll-wrapper').scroll({
                            scrollY: true, scrollX: false, startX: 0, startY: 0,
                            indicators: true, deceleration: 0.0006, bounce: true
                        });
                        var scrollDom = document.querySelector("#convo .mui-scroll-wrapper");
                        if(scrollDom) window.scrollTo(0, scrollDom.scrollHeight);

                        document.querySelector('.mui-scroll-wrapper').addEventListener('scroll', function (e) {
                            let translate = e.target.style?.transform?.match(/translate3d\(\d+px,\s*(\d+)px,\s*(\d+)px\)/i);
                            if (translate && translate.length > 1) {
                                if (translate[1] > 0 && that.isLoadMore == false) {
                                    that.isLoadMore = true;
                                    that.start = that.end + 1;
                                    that.end = that.end + 10;
                                    
                                    util.post("message/getGroupMessagesFromRedis", {
                                        groupId: group.ID,
                                        start: that.start,
                                        end: that.end
                                    }).then(function (res) {
                                        if (res.code === 0 && res.data && res.data.Rows) {
                                            processAndShowGroup(res.data.Rows, true);
                                        }
                                        setTimeout(function() { that.isLoadMore = false; }, 300);
                                    });
                                }
                            }
                        });
                    }, 200);
                }
            },
                // 群聊的初始化（保留更完整的实现在后面）
                // loaduserinfo: function (userid, cb) {
                //     userid = "" + userid;
                //     console.log(">>>> " + userid)
                //     var userinfo = this.usermap[userid];
                //     if (!userinfo) {
                //         utils.post("user/findUser", { userid: parseInt(userid) }, function (res) {
                //             cb(res.Data);
                //             this.usermap[userid] = res.Data;
                //         }.bind(this))
                //     } else {
                //         cb(userinfo)
                //     }
                // },
                loaduserinfo: function (userid, cb) {
                    userid = "" + userid;
                    var userinfo = this.usermap[userid];
                    if (!userinfo) {
                        util.post("user/findUser", { userId: parseInt(userid) })
                            .then(function (res) { // 使用 .then()
                                if (res.code === 0 && res.data) {
                                    cb(res.data);
                                    this.usermap[userid] = res.data;
                                }
                            }.bind(this))
                            .catch(function(err){ console.error('获取用户信息失败', err); });
                    } else {
                        cb(userinfo);
                    }
                },
                onmessage: function (data) {
                    console.log("===【onmessage】调用了，data=", data);
                    // 【重要】不再需要防重逻辑
                    // 因为后端已经不再回显消息给发送者
                    // 前端在 sendtxtmsg 时已经立即显示了自己的消息
                    // 所以这里接收到的消息一定是来自其他用户的

                    // 情况1：私聊消息 (type == 1)
                    if (data.type === 1) {
                        this.loaduserinfo(data.userid, function (user) {
                            this.showmsg(user, data)
                            // 更新好友列表的最后消息预览
                            this.friends.forEach((item) => {
                                if (item.ID == data.userid) {
                                    if (data.media === 1) {
                                        item.memo = data.content
                                    } else if (data.media === 2) {
                                        item.memo = data.url
                                    } else if (data.media === 3) {
                                        item.memo = "[语音]"
                                    } else if (data.media === 4) {
                                        item.memo = "[图片]"
                                    }
                                }
                            })
                        }.bind(this))
                    }
                    // 情况2：群聊消息 (type == 2)
                    else if (data.type === 2) {
                        // 【关键】忽略自己发送的消息（前端在 sendtxtmsg 时已经立即显示了）
                        // 只有在用户处于群聊界面且当前群组ID匹配时，并且消息不是自己发的，才显示
                        if (userid() === data.userid) {
                            // console.log("【群聊】忽略自己发送的消息，消息已在前端 sendtxtmsg 时显示过");
                            return;
                        }
                        
                        if (this.win === 'group' && this.msgcontext.targetid === data.targetid) {
                            this.loaduserinfo(data.userid, function (user) {
                                this.showmsg(user, data)
                            }.bind(this))
                        } else {
                            console.log("用户不在该群聊界面，消息已存储");
                            // 增加该群未读计数
                            try {
                                var gid = data.targetid;
                                var found = false;
                                for (var i in this.groups) {
                                    if (parseInt(this.groups[i].ID) === parseInt(gid)) {
                                        this.$set(this.groups[i], 'unread', (this.groups[i].unread || 0) + 1);
                                        found = true;
                                        break;
                                    }
                                }
                                if (!found) {
                                    // 如果 groups 中不存在该群，仍然增加总数缓存
                                    // 以防短时间内群信息未加载
                                    // console.log('group not found for unread increment', gid)
                                }
                                this.unreadGroupCount = (this.unreadGroupCount || 0) + 1;
                            } catch (e) {
                                console.error('增加群组未读计数失败', e);
                            }
                        }
                    }

                },
                // initwebsocket: function () {
                //     var url = "ws://" + location.host + "/chat?userid=" + userid() + "&token=" + util.parseQuery("token");
                //     this.webSocket = new WebSocket(url);
                //     //消息处理
                //     this.webSocket.onmessage = function (evt) {
                //         console.log("onmessage", evt.data)
                //         if (evt.data.indexOf("}") > -1) {
                //             console.log("recv json <==" + evt.data)
                //             this.onmessage(JSON.parse(evt.data));
                //         } else {
                //             console.log("recv<==" + evt.data)
                //         }
                //     }.bind(this)
                //     //关闭回调
                //     this.webSocket.onclose = function (evt) {
                //         console.log("您已自动下线") //code 1006
                //     }
                //     //出错回调
                //     this.webSocket.onerror = function (evt) {
                //         console.log(evt.data)
                //     }
                //     /*{
                //         this.webSocket.send()
                //     }*/
                // },

                initwebsocket: function () {
                // 步骤 1: 使用一个不包含任何敏感参数的 "干净" URL
                var url = "ws://" + location.host + "/chat";
                this.webSocket = new WebSocket(url);

                // 步骤 2: 【新增】一个 onopen 回调函数
                // 这个函数会在WebSocket连接成功建立时自动触发
                this.webSocket.onopen = function(event) {
                    console.log("WebSocket 连接已成功建立，正在发送认证信息...");
                    
                    // 步骤 3: 构造一个 "认证包" (Auth Packet)
                    var authMessage = {
                        cmd: 1, // 自定义一个命令号, e.g., 1代表认证
                        // data: {
                        //     userid: userid(),
                        //     token: util.parseQuery("token")
                        // }
                        userid: userid(),
                        token: util.parseQuery("token")
                    };
                    
                    // 步骤 4: 将认证包作为第一条消息发送给服务器
                    this.webSocket.send(JSON.stringify(authMessage));
                }.bind(this);

                // 消息处理：支持 JSON 消息 && AI 流式字符串（后端将 token 作为 JSON string 发送）
                this.webSocket.onmessage = function (evt) {
                    console.log("【WebSocket onmessage】收到数据:", evt.data)
                    var handleToken = function (token) {
                        if (!token) return;
                        console.log('[WebSocket] Received AI token:', token);

                        // 1. 获取消息列表的最后一条
                        var lastIndex = this.msglist.length - 1;
                        var lastItem = lastIndex >= 0 ? this.msglist[lastIndex] : null;

                        // 2. 判断最后一条消息是不是 AI 发的
                        // 注意：这里不再循环查找，只看最后一条。
                        // 如果最后一条是你发的，lastItem.msg.userid 就不是 AI_USER_ID，就会走 else 分支创建新气泡
                        if (lastItem && lastItem.msg && lastItem.msg.userid == AI_USER_ID) {
                            // 情况 A：最后一条就是 AI 消息 -> 追加内容
                            lastItem.msg.content = (lastItem.msg.content || '') + token;
                            // 使用 $set 确保 Vue 视图更新
                            this.$set(this.msglist, lastIndex, lastItem);
                            
                            // 可选：流式输出时自动滚动到底部
                            this.$nextTick(() => {
                                // 简单的滚动到底部逻辑，或者调用你现有的滚动方法
                                var scrollDom = document.querySelector("#convo .mui-scroll-wrapper");
                                // 这里可能需要根据你的具体滚动插件调整
                            });

                        } else {
                            // 情况 B：最后一条不是 AI (例如是用户刚发的问题) -> 创建新的聊天框
                            var aiUser = { username: 'AI 助手', icon: '/asset/images/ai_bot.png' };
                            var aiMsg = { 
                                userid: AI_USER_ID, 
                                media: 1, 
                                content: token, 
                                createTime: new Date().getTime(), 
                                type: 1 
                            };
                            // false, false 代表不倒序，不是历史记录加载
                            this.showmsg(aiUser, aiMsg, false, false);
                        }
                    }.bind(this);

                    try {
                        var parsed = JSON.parse(evt.data);
                        if (typeof parsed === 'object') {
                            if (parsed.cmd === -1) {
                                mui.toast('登录认证失败: ' + parsed.msg);
                                this.webSocket.close();
                                return;
                            }
                            console.log("【WebSocket】recv json <==", parsed)
                            this.onmessage(parsed);
                        } else if (typeof parsed === 'string') {
                            handleToken(parsed);
                        } else {
                            console.log('【WebSocket】收到未知 JSON 类型:', parsed);
                        }
                    } catch (err) {
                        // 解析失败，可能是后端直接发送的纯文本 token
                        try {
                            handleToken(evt.data);
                        } catch (e) {
                            console.error('处理非JSON数据失败:', e, evt.data);
                        }
                    }
                }.bind(this)

                // 关闭回调 (onclose) 和 出错回调 (onerror) 保持不变
                this.webSocket.onclose = function (evt) {
                    console.log("您已自动下线") 
                }
                this.webSocket.onerror = function (evt) {
                    console.log(evt.data)
                }
            },
                sendmsg: function () {

                },
                
                // 【新增】从 Redis 读取群聊消息
                // loadGroupMessagesFromRedis: function (groupId) {
                //     // 【改进】每次都重新加载（不使用缓存检查）
                //     // console.log("【loadGroupMessagesFromRedis】开始加载群聊历史消息，groupId=", groupId);
                    
                //     var that = this;
                //     util.post("message/getGroupMessagesFromRedis", { 
                //         groupId: groupId 
                //     })
                //     .then(function (res) {
                //         // console.log("【loadGroupMessagesFromRedis】从 Redis 获取消息结果:", res);
                        
                //         if (res.code === 0 && res.data && res.data.length > 0) {
                //             // 遍历消息列表，依次显示
                //             res.data.forEach((msg, index) => {
                //                 // 使用延时来避免一次性渲染过多消息导致卡顿
                //                 setTimeout(() => {
                //                         that.loaduserinfo(msg.userid, function (user) {
                //                         that.showmsg(user, msg, false, false);
                //                     });
                //                 }, index * 50);
                //             });
                //         } else if (res.code !== 0) {
                //             console.log("获取群聊消息失败:", res.msg);
                //         }
                        
                //     })
                //     .catch(function (err) {
                //         console.error("从 Redis 读取群聊消息失败:", err);
                //     });
                // },
                
                // findfriends: function () {
                //     var that = this;
                //     console.log("Calling util.post('findFriends')..."); // 确认函数被调用
                //     // post("searchFriends", { userid: userid() }, function (res) {
                //     util.post("findFriends", { userid: userid() }, function (res) {
                //         console.log("Promise resolved! Server response:", res); // 关键日志
                //         that.friends = res.data.Rows || [];
                //         // console.log(res.data.Rows)
                //         var usermap = this.usermap;
                //         for (var i in res.data.Rows) {
                //             var k = "" + res.data.Rows[i].ID
                //             usermap[k] = res.data.Rows[i];
                //         }
                //         this.usermap = usermap;
                //     }.bind(this))
                // },
                findfriends: function () {
                    var that = this; // 在 Promise 外部保存 this 的引用
                    // console.log("Calling util.post('findFriends')..."); 

                    // util.post 返回一个 Promise
                    util.post("findFriends", { userid: userid() }) 
                        .then(function (res) {
                            // 当 Promise 成功解决 (resolved) 时，这里的代码会被执行
                            console.log("Promise resolved! Server response:", res); // 现在这个日志应该会打印了！
                            
                            // 检查后端返回的 code 是否为 0
                            if (res.code === 0 && res.data) {
                                that.friends = res.data.Rows || [];
                                
                                var usermap = that.usermap; // 使用 that 来访问 Vue 实例
                                for (var i in res.data.Rows) {
                                    var k = "" + res.data.Rows[i].ID;
                                    usermap[k] = res.data.Rows[i];
                                }
                                that.usermap = usermap; // 使用 that
                            } else {
                                // 如果后端返回错误码，也打印出来
                                console.error("Server returned an error:", res.msg);
                                mui.toast(res.msg || "加载好友失败");
                            }
                        })
                        .catch(function (err) {
                            // 当 Promise 被拒绝 (rejected) 时（例如网络错误、JSON解析失败），这里的代码会被执行
                            console.error("Promise rejected! An error occurred:", err);
                            mui.toast(err.msg || "网络请求失败");
                        });
                },
                loadgroups: function () {
                    var that = this;
                    util.post("group/loadGroups", { userid: userid() })
                        .then(function (res) {
                            if (res.code === 0 && res.data) {
                                that.groups = res.data.Rows || [];
                                // 初始化每个群的未读计数为0，并计算总数（如果后端没有提供未读）
                                that.unreadGroupCount = 0;
                                for (var i in that.groups) {
                                    if (typeof that.groups[i].unread === 'undefined') {
                                        that.groups[i].unread = 0;
                                    }
                                    that.unreadGroupCount += that.groups[i].unread || 0;
                                }
                            } else {
                                mui.toast(res.msg || '加载群组列表失败');
                            }
                        })
                        .catch(function (err) {
                            mui.toast(err.msg || '网络错误');
                        });
                },
                addfriend: function () {
                    //console.log("addfriend....")
                    var that = this;
                    mui.prompt('', '请输入好友名称', '加好友', ['取消', '确认'], function (e) {
                        if (e.index == 1) {
                            //判断数字
                            //if (isNaN(e.value) || e.value <= 0) {
                            //    mui.toast('格式错误');
                            //} else {
                            //mui.toast(e.value);
                            that._addfriend(e.value)
                            //}
                        } else {
                            //mui.toast('您取消了入库');
                        }
                    }, 'div');
                    document.querySelector('.mui-popup-input input').type = 'text';

                },
                // _addfriend: function (dstobj) {
                //     //防止一次点击 穿透访问多次
                //     if (this.isDisable) {
                //         this.setTimeFlag()
                //         //console.log("_addfriend....")
                //         var that = this
                //         utils.post("contact/addfriend", { targetName: dstobj, userid: userid() }, function (res) {
                //             if (res.Code == 0) {
                //                 mui.toast("添加成功");
                //                 that.loadfriends();
                //             } else {
                //                 mui.toast(res.Msg);
                //             }
                //         })
                //     }
                // },
                _addfriend: function (dstobj) {
                    if (this.isDisable) {
                        this.setTimeFlag();
                        var that = this;
                        // 假设这里调用的是 util.post
                        util.post("contact/addfriend", {userid: userid(), friendname: dstobj })
                            .then(function (res) {
                                if (res.code === 0) {
                                    mui.toast("添加成功");
                                    that.findfriends(); // 重新加载好友列表
                                } else {
                                    mui.toast(res.msg || '添加好友失败');
                                }
                            })
                            .catch(function (err) {
                                mui.toast(err.msg || '网络错误');
                            });
                    }
                },
                //个人资料修改显示
                setUserInfo: function () {
                    this.win = "userinfo"
                    //  console.log("createCom")
                },
                //新建群显示
                createCom: function () {
                    this.win = "commiunity"
                    //  console.log("createCom")
                },

                //新建群提交
                creategroup() {
                    this.com.ownerId = userid()
                    console.log(this.com)
                    util.post("/group/createGroup", this.com).then(res => {
                        console.log(res)
                        if (res.Code != 0) {
                            mui.toast(res.Msg)
                        } else {
                            //location.replace("localhost:8081")
                            //location.href = "/"
                            mui.toast("建群成功")
                            this.loadgroups();
                            //goBack()
                        }
                    })
                },
                updateUserInfo() {
                    this.info.userid = userid()
                    util.post("/user/updateUserInfo", this.info).then(res => {
                        console.log(res)
                        let userInfo = JSON.parse(sessionStorage.getItem('userinfo') || '{}');
                        userInfo.icon = this.info.icon;
                        userInfo.username = this.info.username;
                        userInfo.phone = this.info.phone;
                        userInfo.email = this.info.email;
                        sessionStorage.setItem('userinfo', JSON.stringify(userInfo))
                        if (res.Code != 0) {
                            mui.toast(res.msg)
                        } else {
                            //location.replace("localhost:8081")
                            //location.href = "/"
                            mui.toast("修改成功")
                            //goBack()
                        }
                    })
                },



                //回到聊天首页
                goBack() {
                    this.win = "main"
                },
                _joincomunity: function (dstobj) {
                    if (this.isDisable) {
                        this.setTimeFlag();
                        var that = this;
                        // 假设这里调用的是 util.post
                        util.post("contact/joinGroup", { comId: dstobj, "userId": userId() })
                            .then(function (res) {
                                if (res.code === 0) {
                                    mui.toast("添加成功");
                                    that.loadgroups(); // 调用我们已经修改好的 loadgroups
                                } else {
                                    mui.toast(res.msg || '加入群聊失败');
                                }
                            })
                            .catch(function (err) {
                                mui.toast(err.msg || '网络错误');
                            });
                    }
                },
                joincom: function () {
                    var that = this;
                    mui.prompt('', '请输入群号或者群名称', '加群', ['取消', '确认'], function (e) {
                        if (e.index == 1) {
                            //    if (isNaN(e.value) || e.value <= 0) {
                            //       mui.toast('格式错误');
                            //   } else {
                            //mui.toast(e.value);
                            that._joincomunity(e.value)
                            // }
                        } else {
                            //mui.toast('您取消了入库');
                        }
                    }, 'div');
                    document.querySelector('.mui-popup-input input').type = 'text';
                },
                quit: function () {
                    sessionStorage.removeItem("userid")
                    sessionStorage.removeItem("userinfo")
                    location.href = "/"
                },
                setTimeFlag() {
                    this.isDisable = false;
                    setTimeout(() => {
                        this.isDisable = true;
                    }, 100)
                },
                heartbeat() {
                    if (this.webSocket.readyState == 1) {  //失去连接 3
                        var msg = this.createmsgcontext();
                        msg.Media = -1;
                        msg.Type = 3
                        msg.Content = "心跳";
                        //this.showmsg(userInfo(),msg);
                        this.webSocket.send(JSON.stringify(msg))
                    }

                },
                quit: function () {
                    // 1. 清除本地存储的 Token 和用户信息
                    sessionStorage.removeItem("userid");
                    sessionStorage.removeItem("userinfo");
                    sessionStorage.removeItem("token"); 

                    // 2. 主动断开 WebSocket 连接 
                    if (this.webSocket && this.webSocket.close) {
                        this.webSocket.close();
                    }

                    // 3. 跳转回登录页面
                    location.href = "/index"; 
                },


            },
            watch: {
                "win": function (n, o) {
                    // console.log("watch",o,n)
                    if (n != "main") {
                        document.getElementById("menubar").style.display = "none";
                    } else {
                        document.getElementById("menubar").style.display = "block";
                    }
                }
            }
        }
    )

    // 为了调试与外部脚本访问，暴露全局 Vue 实例
    try { window.app = app; } catch (e) { console.warn('expose app failed', e); }

</script>
{{end}}